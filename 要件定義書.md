# MACA堂 B2Bシステム 要件定義書

**文書バージョン**: 1.0  
**作成日**: 2025年8月18日  
**対象システム**: MACA堂 ポーション販売 B2B注文管理システム  
**ドメイン**: macado.tes.bz  

---

## 📋 目次

1. [システム概要](#システム概要)
2. [現状分析](#現状分析)
3. [機能要件](#機能要件)
4. [技術仕様](#技術仕様)
5. [データベース設計](#データベース設計)
6. [環境設定](#環境設定)
7. [未解決課題](#未解決課題)
8. [引き継ぎ事項](#引き継ぎ事項)

---

## 🎯 システム概要

### ビジネス概要
MACA堂は魔法のポーション（体力回復、魔力回復、解毒など）を製造・販売する企業です。B2B（法人向け）販売において、以下の課題を解決するためのWebシステムを構築します。

### 解決すべき課題
1. **申込プロセスの効率化**: 法人顧客の新規申込から承認までの流れ
2. **注文管理の自動化**: 既存顧客の継続注文と新規顧客の簡単注文
3. **価格管理の柔軟性**: 顧客ランク別価格設定と割引管理
4. **承認フローの明確化**: 経理確認→社長承認の段階的プロセス
5. **顧客情報の一元管理**: 顧客データベースと注文履歴の統合

### システムの目的
- **業務効率化**: 手作業による申込・注文処理の自動化
- **顧客満足度向上**: 24時間対応可能な注文システム
- **売上向上**: 簡単注文システムによる注文頻度の増加
- **管理精度向上**: データベース化による情報管理の正確性

---

## 📊 現状分析

### 開発済み機能（95%完成）

#### ✅ 完成済みシステム
1. **申込フォームシステム**
   - 法人情報入力フォーム
   - 自動メール送信機能
   - Supabaseデータベース連携

2. **管理者用システム**
   - 申込管理画面
   - 顧客管理機能
   - 注文管理機能
   - 売上分析・グラフ表示
   - 価格設定機能

3. **顧客認証システム**
   - 新規登録機能
   - ログイン機能
   - パスワードリセット機能
   - メール認証機能

4. **新規注文ポータル**
   - ログイン不要の簡単注文
   - 商品選択・数量指定
   - 顧客情報入力

### 🔧 技術スタック（実装済み）
- **フロントエンド**: React 18 + Vite
- **スタイリング**: Tailwind CSS
- **データベース**: Supabase (PostgreSQL)
- **認証**: Supabase Auth
- **ホスティング**: エックスサーバー (macado.tes.bz)
- **開発環境**: Node.js 20.18.0

### ⚠️ 現在の課題
1. **ホワイトアウト問題**: React アプリが正常に表示されない
2. **環境変数未設定**: Supabase接続情報がエックスサーバーで未設定
3. **静的ファイル配信**: Reactアプリの静的ファイル化が不完全

---

## 🔧 機能要件

### 1. 申込フォームシステム

#### 1.1 法人新規申込機能
**URL**: `https://macado.tes.bz/` (申込フォーム)

**入力項目**:
- 会社名 (必須)
- 代表者名 (必須)
- 所在地 (必須)
- 電話番号 (必須)
- メールアドレス (必須)
- 業種 (選択式)
- 従業員数 (選択式)
- 希望商品カテゴリ (複数選択可)
- 月間予想注文量 (選択式)
- 支払い方法希望 (選択式)

**処理フロー**:
1. フォーム送信 → Supabaseに保存
2. 自動確認メール送信 (申込者宛)
3. 管理者への通知メール送信
4. ステータス: "申込受付" → "経理確認中" → "社長承認待ち" → "承認完了"

#### 1.2 申込管理機能（管理者用）
- **申込一覧表示**: ステータス別フィルタリング、検索機能
- **申込詳細確認**: 全入力情報の表示
- **承認フロー管理**: 経理確認→社長承認→却下機能

### 2. 顧客管理システム

#### 2.1 顧客データベース管理
- 顧客ID (自動採番)
- 会社名、代表者名、連絡先
- 契約日、顧客ランク (A/B/C)
- 累計注文金額、最終注文日

#### 2.2 顧客ランク管理
- **Aランク**: 月間50万円以上 (割引率15%)
- **Bランク**: 月間20万円以上 (割引率10%)
- **Cランク**: 月間20万円未満 (割引率5%)

### 3. 注文管理システム

#### 3.1 既存顧客向け注文システム
**URL**: `https://macado.tes.bz/login/`
- メール + パスワード認証
- 商品選択・カート機能
- 配送先指定・注文確認

#### 3.2 新規顧客向け簡単注文システム
**URL**: `https://macado.tes.bz/order/`
- ログイン不要
- 簡単な商品選択
- 顧客情報入力（初回のみ）

### 4. 価格管理システム

**価格体系**:
- 基本価格
- ランク別価格（自動割引）
- 特別価格（個別設定）
- 期間限定価格

**価格計算ロジック**:
```
最終価格 = 基本価格 × (1 - ランク割引率) × (1 - 特別割引率)
```

### 5. 売上分析システム

**レポート種類**:
- 日次売上
- 月次売上比較
- 顧客別売上ランキング
- 商品別売上分析

**ダッシュボード表示項目**:
- 本日の売上
- 今月の売上目標達成率
- 新規注文件数
- 未処理注文件数

---

## 🛠️ 技術仕様

### アーキテクチャ概要
```
フロントエンド(React+Vite) → Supabase API → PostgreSQL DB
```

### フロントエンド技術仕様
- **React**: 18.3.1
- **Vite**: 6.3.5
- **TypeScript**: 推奨
- **Tailwind CSS**: 3.4.15
- **React Router**: ルーティング

### バックエンド技術仕様
- **Supabase**: PostgreSQL 15
- **Auth**: メール認証・パスワードリセット
- **Storage**: ファイルアップロード（将来拡張）

### セキュリティ
- JWT トークンによる認証
- HTTPS通信強制
- 入力値検証（フロント・バック双方）
- Role-Based Access Control (RBAC)

---

## 💾 データベース設計

### テーブル一覧

**applications** - 申込テーブル
```sql
CREATE TABLE applications (
  id UUID PRIMARY KEY,
  company_name VARCHAR(255) NOT NULL,
  representative_name VARCHAR(255) NOT NULL,
  email VARCHAR(255) NOT NULL,
  phone VARCHAR(20) NOT NULL,
  address TEXT NOT NULL,
  business_type VARCHAR(100),
  employee_count VARCHAR(50),
  desired_products TEXT[],
  monthly_volume VARCHAR(50),
  payment_method VARCHAR(50),
  status VARCHAR(50) DEFAULT 'received',
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

**customers** - 顧客テーブル
```sql
CREATE TABLE customers (
  id UUID PRIMARY KEY,
  company_name VARCHAR(255) NOT NULL,
  representative_name VARCHAR(255) NOT NULL,
  email VARCHAR(255) UNIQUE NOT NULL,
  phone VARCHAR(20),
  customer_rank VARCHAR(1) DEFAULT 'C',
  total_orders_amount DECIMAL(12,2) DEFAULT 0,
  last_order_date DATE,
  discount_rate DECIMAL(5,2) DEFAULT 0,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

**products** - 商品テーブル
```sql
CREATE TABLE products (
  id UUID PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  category VARCHAR(100) NOT NULL,
  description TEXT,
  base_price DECIMAL(10,2) NOT NULL,
  cost_price DECIMAL(10,2),
  stock_quantity INTEGER DEFAULT 0,
  image_url VARCHAR(500),
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

**orders** - 注文テーブル
```sql
CREATE TABLE orders (
  id UUID PRIMARY KEY,
  customer_id UUID REFERENCES customers(id),
  order_number VARCHAR(50) UNIQUE NOT NULL,
  status VARCHAR(50) DEFAULT 'pending',
  total_amount DECIMAL(12,2) NOT NULL,
  final_amount DECIMAL(12,2) NOT NULL,
  shipping_address TEXT,
  order_date TIMESTAMP DEFAULT NOW(),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

**order_items** - 注文明細テーブル
```sql
CREATE TABLE order_items (
  id UUID PRIMARY KEY,
  order_id UUID REFERENCES orders(id),
  product_id UUID REFERENCES products(id),
  quantity INTEGER NOT NULL,
  unit_price DECIMAL(10,2) NOT NULL,
  total_price DECIMAL(12,2) NOT NULL,
  created_at TIMESTAMP DEFAULT NOW()
);
```

---

## 🔌 環境設定

### 開発環境
**必要なソフトウェア**:
- Node.js 20.18.0以上
- npm または pnpm
- Git

**環境変数 (.env.local)**:
```env
VITE_SUPABASE_URL=https://xidqwtne.supabase.co
VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
VITE_APP_NAME=MACA堂 B2B注文管理システム
```

### 本番環境（エックスサーバー）
**サーバー情報**:
- ホスト: sv13198.xserver.jp
- ドメイン: macado.tes.bz
- FTPユーザー: admin@macado.tes.bz

**ディレクトリ構成**:
```
public_html/
├── admin/        # 管理者用システム
├── login/        # 顧客ログイン
├── order/        # 新規注文ポータル
└── index.html    # トップページ
```

---

## ⚠️ 未解決課題

### 🔴 ホワイトアウト問題（最優先）

**現象**:
- `https://macado.tes.bz/admin/` にアクセスすると白い画面が表示される

**原因**:
1. 環境変数がエックスサーバーで未設定
2. Reactアプリの静的ファイル化が不完全
3. 相対パス設定が不適切

**解決方法**:
```javascript
// vite.config.js に base: './' を追加
export default defineConfig({
  base: './',
  // ...
})
```

```javascript
// src/lib/supabase.js に接続情報を直接記述
const supabaseUrl = 'https://xidqwtne.supabase.co'
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'
export const supabase = createClient(supabaseUrl, supabaseKey)
```

### 🟡 環境変数設定問題
- 静的ファイルでは環境変数が使用不可
- Supabase接続情報を直接コードに埋め込む必要あり

### 🟢 機能拡張項目
- AI質問機能（ダッシュボード分析）
- ソーシャルログイン（Google/LINE）
- モバイル対応強化
- PWA対応

---

## 📋 引き継ぎ事項

### 即座に対応が必要な作業

#### Step 1: ホワイトアウト問題の解決
```bash
# 1. 環境変数を直接埋め込み
cd maca-b2b-system/src/lib
# supabase.js を編集して接続情報を直接記述

# 2. 再ビルド
npm run build

# 3. FTPアップロード
# ビルドファイルをエックスサーバーにアップロード

# 4. 動作確認
# https://macado.tes.bz/admin/ で確認
```

#### Step 2: 基本機能テスト
1. 申込フォーム: 新規申込の送信・保存確認
2. 管理画面: ログイン・データ表示確認
3. 顧客ログイン: 新規登録・ログイン確認
4. 注文システム: 注文作成・管理確認

### ローカル開発環境構築
```bash
git clone [リポジトリURL]
cd maca-b2b-system
npm install
cp .env.example .env.local
# .env.local を編集してSupabase情報を設定
npm run dev
```

### 本番デプロイ手順
```bash
npm run build
# dist/ フォルダをエックスサーバーにアップロード
```

---

## 📊 システム完成度: **95%**

### 完成済み機能
- ✅ 申込フォームシステム
- ✅ 顧客管理システム
- ✅ 注文管理システム
- ✅ 価格管理システム
- ✅ 売上分析システム
- ✅ 認証システム

### 残り作業
- 🔴 ホワイトアウト問題解決（最優先）
- 🟡 環境変数設定修正
- 🟢 機能拡張・改善

---

**推定作業時間**:
- 緊急修正: 1-2日
- 完全運用開始: 1週間以内

---

_更新日: 2026年2月13日_
